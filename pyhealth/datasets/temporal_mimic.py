"""
PyHealth dataset for the Temporal MIMIC dataset.

Name: Erwan Caron
NetID: ecaron2
Reproducing Paper Title: HIST-AID: Leveraging Historical Patient Reports for Enhanced Multi-Modal Automatic Diagnosis
Paper Link: https://arxiv.org/abs/2411.10684

The Temporal MIMIC dataset integrates five years of patient history, including radiographic scans and reports from the MIMIC-CXR and MIMIC-IV datasets.
"""

import logging
from pathlib import Path
from typing import List, Optional
from pprint import pprint

from pyhealth.tasks.temporal_mimic import TemporalMIMICMultilabelClassification

from .base_dataset import BaseDataset

logger = logging.getLogger(__name__)

class TemporalMIMICDataset(BaseDataset):
    """
    PyHealth dataset for the Temporal MIMIC dataset.

    # Requires the preprocessed Temporal MIMIC CSV generated by the HIST-AID pipeline.
    # Instructions to build the CSV are here: https://github.com/NoTody/HIST-AID/tree/main/data_generation

    # Each row is one visit (subject_id = patient, study_id = visit).

    Args:
        root (str): The root directory where the dataset is stored.
        tables (List[str]): A list of tables to be included in the dataset.
        dataset_name (Optional[str]): The name of the dataset.
        config_path (Optional[str]): The path to the configuration file.
        classes (List[str]): List of pathologies labels that appear in the dataset.
    """

    classes: List[str] = [
        "Atelectasis",
        "Cardiomegaly",
        "Consolidation",
        "Edema",
        "Enlarged Cardiomediastinum",
        "Fracture",
        "Lung Lesion",
        "Lung Opacity",
        "No Finding",
        "Pleural Effusion",
        "Pleural Other",
        "Pneumonia",
        "Pneumothorax",
    ]

    def __init__(
        self,
        root: str,
        tables: List[str] = None,
        dataset_name: Optional[str] = None,
        config_path: Optional[str] = None,
        **kwargs,
    ) -> None:
        if config_path is None:
            logger.info("No config path provided, using default temporal_mimic config")
            config_path = Path(__file__).parent / "configs" / "temporal_mimic.yaml"

        default_tables = ["temporal_mimic"]
        tables = default_tables + (tables or [])

        super().__init__(
            root=root,
            tables=tables,
            dataset_name=dataset_name or "temporal_mimic",
            config_path=config_path,
            **kwargs,
        )

    @property
    def default_task(self):
        """Returns the default task for this dataset.

        Returns:
            TemporalMIMICMultilabelClassification: The default classification task.
        """
        return TemporalMIMICMultilabelClassification()

if __name__ == "__main__":
    """Example usage of TemporalMIMICDataset and the default task
    
        The root folder must contain your preprocessed Temporal MIMIC CSV file, named temporal_mimic.csv.
    """
    # set root to the folder path containing your preprocessed Temporal MIMIC CSV (named temporal_mimic.csv) generated by the HIST-AID pipeline
    dataset = TemporalMIMICDataset(
        root="/srv/local/data/temporalmimic/",
        dev=True,
    )

    dataset.stats()

    # Display information about the first patient.
    patient_iter = dataset.iter_patients()
    first_patient = next(patient_iter)
    df_events = first_patient.get_events(return_df=True)

    print("First patient ID:", first_patient.patient_id)
    print(df_events.head())

    # Execute the default task
    task = TemporalMIMICMultilabelClassification(
        image_root="/srv/local/data/MIMIC-CXR-JPG",
    )

    sample_dataset = dataset.set_task(task)

    print("Number of samples:", len(sample_dataset))
    pprint(sample_dataset.samples[0])
